(function(_0x12d7f6,_0x4b694f){const _0x486866=a0_0x4f8f,_0x557f5b=_0x12d7f6();while(!![]){try{const _0x1d0bb9=-parseInt(_0x486866(0xd3))/0x1+-parseInt(_0x486866(0xd0))/0x2*(parseInt(_0x486866(0xe3))/0x3)+-parseInt(_0x486866(0x102))/0x4*(parseInt(_0x486866(0xf2))/0x5)+parseInt(_0x486866(0xdd))/0x6+-parseInt(_0x486866(0xdb))/0x7*(parseInt(_0x486866(0xe2))/0x8)+parseInt(_0x486866(0xea))/0x9+-parseInt(_0x486866(0xf3))/0xa*(-parseInt(_0x486866(0xcd))/0xb);if(_0x1d0bb9===_0x4b694f)break;else _0x557f5b['push'](_0x557f5b['shift']());}catch(_0x34a693){_0x557f5b['push'](_0x557f5b['shift']());}}}(a0_0x483c,0x7cd28));import{connect}from'cloudflare:sockets';import a0_0x3aa272 from'js-sha256';export async function trojanOverWSHandler(_0x201144){const _0x11a52b=a0_0x4f8f,_0x13926d=new WebSocketPair(),[_0x1e861c,_0x56d340]=Object[_0x11a52b(0x10a)](_0x13926d);_0x56d340[_0x11a52b(0xf0)]();let _0x495b3b='',_0x55a76a='';const _0x718e1=(_0x53d3d8,_0x303e67)=>{console['log']('['+_0x495b3b+':'+_0x55a76a+']\x20'+_0x53d3d8,_0x303e67||'');},_0xfeb740=_0x201144[_0x11a52b(0x100)][_0x11a52b(0xf4)](_0x11a52b(0xda))||'',_0x4ecc71=makeReadableWebSocketStream(_0x56d340,_0xfeb740,_0x718e1);let _0x3c89e8={'value':null},_0x90cb7f=null;return _0x4ecc71[_0x11a52b(0xdc)](new WritableStream({async 'write'(_0xe6e48d,_0x11f76c){const _0x50cb4c=_0x11a52b;if(_0x90cb7f)return _0x90cb7f(_0xe6e48d);if(_0x3c89e8[_0x50cb4c(0x107)]){const _0x57922b=_0x3c89e8[_0x50cb4c(0x107)][_0x50cb4c(0xe4)][_0x50cb4c(0xff)]();await _0x57922b['write'](_0xe6e48d),_0x57922b[_0x50cb4c(0xe6)]();return;}const {hasError:_0x31e0a9,message:_0x2be7ca,portRemote:portRemote=0x1bb,addressRemote:addressRemote='',rawClientData:_0x2e309a}=await parseTrojanHeader(_0xe6e48d);_0x495b3b=addressRemote,_0x55a76a=portRemote+'--'+Math[_0x50cb4c(0xd9)]()+_0x50cb4c(0xf5);if(_0x31e0a9){throw new Error(_0x2be7ca);return;}handleTCPOutBound(_0x3c89e8,addressRemote,portRemote,_0x2e309a,_0x56d340,_0x718e1);},'close'(){_0x718e1('readableWebSocketStream\x20is\x20closed');},'abort'(_0x4c6a11){const _0x2aface=_0x11a52b;_0x718e1(_0x2aface(0x10f),JSON[_0x2aface(0xd5)](_0x4c6a11));}}))[_0x11a52b(0xfa)](_0x317cc1=>{const _0x5a3b50=_0x11a52b;_0x718e1(_0x5a3b50(0x109),_0x317cc1);}),new Response(null,{'status':0x65,'webSocket':_0x1e861c});}async function parseTrojanHeader(_0x3c276d){const _0xf841e9=a0_0x4f8f;if(_0x3c276d[_0xf841e9(0xd7)]<0x38)return{'hasError':!![],'message':_0xf841e9(0x106)};let _0x5d62a9=0x38;if(new Uint8Array(_0x3c276d[_0xf841e9(0x10d)](0x38,0x39))[0x0]!==0xd||new Uint8Array(_0x3c276d['slice'](0x39,0x3a))[0x0]!==0xa)return{'hasError':!![],'message':_0xf841e9(0xe1)};const _0x3b7c53=new TextDecoder()[_0xf841e9(0x105)](_0x3c276d[_0xf841e9(0x10d)](0x0,_0x5d62a9));if(_0x3b7c53!==a0_0x3aa272['sha224'](globalThis[_0xf841e9(0x10e)]))return{'hasError':!![],'message':_0xf841e9(0xed)};const _0x554746=_0x3c276d[_0xf841e9(0x10d)](_0x5d62a9+0x2);if(_0x554746[_0xf841e9(0xd7)]<0x6)return{'hasError':!![],'message':'invalid\x20SOCKS5\x20request\x20data'};const _0x1980b8=new DataView(_0x554746),_0x30e98c=_0x1980b8[_0xf841e9(0xf9)](0x0);if(_0x30e98c!==0x1)return{'hasError':!![],'message':_0xf841e9(0xf7)};const _0x44592c=_0x1980b8[_0xf841e9(0xf9)](0x1);let _0x4cb15b=0x0,_0x3249e4=0x2,_0xef120f='';switch(_0x44592c){case 0x1:_0x4cb15b=0x4,_0xef120f=new Uint8Array(_0x554746[_0xf841e9(0x10d)](_0x3249e4,_0x3249e4+_0x4cb15b))[_0xf841e9(0xe5)]('.');break;case 0x3:_0x4cb15b=new Uint8Array(_0x554746[_0xf841e9(0x10d)](_0x3249e4,_0x3249e4+0x1))[0x0],_0x3249e4+=0x1,_0xef120f=new TextDecoder()['decode'](_0x554746['slice'](_0x3249e4,_0x3249e4+_0x4cb15b));break;case 0x4:_0x4cb15b=0x10;const _0x44375e=new DataView(_0x554746[_0xf841e9(0x10d)](_0x3249e4,_0x3249e4+_0x4cb15b)),_0x1da2a8=[];for(let _0x4cb93b=0x0;_0x4cb93b<0x8;_0x4cb93b++){_0x1da2a8[_0xf841e9(0xec)](_0x44375e['getUint16'](_0x4cb93b*0x2)[_0xf841e9(0xef)](0x10));}_0xef120f=_0x1da2a8[_0xf841e9(0xe5)](':');break;default:return{'hasError':!![],'message':_0xf841e9(0xeb)+_0x44592c};}if(!_0xef120f)return{'hasError':!![],'message':'address\x20is\x20empty,\x20addressType\x20is\x20'+_0x44592c};const _0x119d42=_0x3249e4+_0x4cb15b,_0x49e8d5=_0x554746['slice'](_0x119d42,_0x119d42+0x2),_0x42ab6c=new DataView(_0x49e8d5)['getUint16'](0x0);return{'hasError':![],'addressRemote':_0xef120f,'portRemote':_0x42ab6c,'rawClientData':_0x554746[_0xf841e9(0x10d)](_0x119d42+0x4)};}async function handleTCPOutBound(_0x28a6b5,_0x461715,_0x2f8e41,_0x21b376,_0x243422,_0x25c8a9){async function _0x4001a1(_0x4336a3,_0x4e7246){const _0x2b48be=a0_0x4f8f;if(/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/[_0x2b48be(0xf1)](_0x4336a3))_0x4336a3=''+atob(_0x2b48be(0x104))+_0x4336a3+atob(_0x2b48be(0xcc));const _0x281785=connect({'hostname':_0x4336a3,'port':_0x4e7246});_0x28a6b5['value']=_0x281785,_0x25c8a9('connected\x20to\x20'+_0x4336a3+':'+_0x4e7246);const _0xa59c4f=_0x281785[_0x2b48be(0xe4)][_0x2b48be(0xff)]();return await _0xa59c4f[_0x2b48be(0x101)](_0x21b376),_0xa59c4f[_0x2b48be(0xe6)](),_0x281785;}async function _0x2365bf(){const _0x306a02=a0_0x4f8f,_0x46428b=globalThis[_0x306a02(0xcf)][_0x306a02(0x103)]('/')[0x2],_0x129ab9=_0x46428b?atob(_0x46428b)[_0x306a02(0x103)](','):undefined,_0x21285c=_0x129ab9?_0x129ab9[Math[_0x306a02(0xee)](Math[_0x306a02(0xd9)]()*_0x129ab9['length'])]:globalThis['proxyIP']||_0x461715,_0x2f887c=await _0x4001a1(_0x21285c,_0x2f8e41);_0x2f887c[_0x306a02(0x10b)]['catch'](_0x301897=>{const _0x468957=_0x306a02;console[_0x468957(0xde)]('retry\x20tcpSocket\x20closed\x20error',_0x301897);})['finally'](()=>{safeCloseWebSocket(_0x243422);}),trojanRemoteSocketToWS(_0x2f887c,_0x243422,null,_0x25c8a9);}const _0x425118=await _0x4001a1(_0x461715,_0x2f8e41);trojanRemoteSocketToWS(_0x425118,_0x243422,_0x2365bf,_0x25c8a9);}function makeReadableWebSocketStream(_0x3c1ab8,_0x1fc9dd,_0x1323da){let _0x263b06=![];const _0x1564dc=new ReadableStream({'start'(_0x1e6d4f){const _0x428585=a0_0x4f8f;_0x3c1ab8[_0x428585(0xe9)]('message',_0xa1ee3f=>{const _0x146793=_0x428585;if(_0x263b06)return;const _0x141d4c=_0xa1ee3f[_0x146793(0xf6)];_0x1e6d4f[_0x146793(0xe8)](_0x141d4c);}),_0x3c1ab8[_0x428585(0xe9)](_0x428585(0xd2),()=>{const _0x55bc09=_0x428585;safeCloseWebSocket(_0x3c1ab8);if(_0x263b06)return;_0x1e6d4f[_0x55bc09(0xd2)]();}),_0x3c1ab8['addEventListener']('error',_0x4818f3=>{const _0x1f0da0=_0x428585;_0x1323da(_0x1f0da0(0xd6)),_0x1e6d4f[_0x1f0da0(0x10c)](_0x4818f3);});const {earlyData:_0x46704a,error:_0x1634a2}=base64ToArrayBuffer(_0x1fc9dd);if(_0x1634a2)_0x1e6d4f['error'](_0x1634a2);else _0x46704a&&_0x1e6d4f[_0x428585(0xe8)](_0x46704a);},'pull'(_0x34ef85){},'cancel'(_0x2d28a2){if(_0x263b06)return;_0x1323da('ReadableStream\x20was\x20canceled,\x20due\x20to\x20'+_0x2d28a2),_0x263b06=!![],safeCloseWebSocket(_0x3c1ab8);}});return _0x1564dc;}async function trojanRemoteSocketToWS(_0x300b70,_0xa6cd2c,_0x51636a,_0x5795e9){const _0x484a41=a0_0x4f8f;let _0x378e90=![];await _0x300b70[_0x484a41(0x108)][_0x484a41(0xdc)](new WritableStream({'start'(){},async 'write'(_0x58904e,_0x463680){const _0x2113f3=_0x484a41;_0x378e90=!![],_0xa6cd2c[_0x2113f3(0xd1)]!==WS_READY_STATE_OPEN&&_0x463680[_0x2113f3(0x10c)](_0x2113f3(0xfe)),_0xa6cd2c['send'](_0x58904e);},'close'(){const _0x2ff440=_0x484a41;_0x5795e9(_0x2ff440(0xfd)+_0x378e90);},'abort'(_0x28430e){const _0x46429a=_0x484a41;console[_0x46429a(0x10c)](_0x46429a(0xd4),_0x28430e);}}))[_0x484a41(0xfa)](_0x1ac8cb=>{const _0x20fc21=_0x484a41;console[_0x20fc21(0x10c)](_0x20fc21(0xfb),_0x1ac8cb[_0x20fc21(0xdf)]||_0x1ac8cb),safeCloseWebSocket(_0xa6cd2c);}),_0x378e90===![]&&_0x51636a&&(_0x5795e9(_0x484a41(0xce)),_0x51636a());}function base64ToArrayBuffer(_0x4983f2){const _0x5adeb2=a0_0x4f8f;if(!_0x4983f2)return{'earlyData':null,'error':null};try{_0x4983f2=_0x4983f2[_0x5adeb2(0xe0)](/-/g,'+')['replace'](/_/g,'/');const _0xd5d8a3=atob(_0x4983f2),_0x355456=Uint8Array[_0x5adeb2(0xd8)](_0xd5d8a3,_0x2810b1=>_0x2810b1[_0x5adeb2(0xfc)](0x0));return{'earlyData':_0x355456[_0x5adeb2(0xe7)],'error':null};}catch(_0x3388e9){return{'earlyData':null,'error':_0x3388e9};}}function a0_0x483c(){const _0x5ea92f=['join','releaseLock','buffer','enqueue','addEventListener','6616467ydvGfz','invalid\x20addressType\x20is\x20','push','invalid\x20password','floor','toString','accept','test','85VJTLDV','13853050QgKcTO','get','\x20tcp','data','unsupported\x20command,\x20only\x20TCP\x20(CONNECT)\x20is\x20allowed','safeCloseWebSocket\x20error','getUint8','catch','trojanRemoteSocketToWS\x20error:','charCodeAt','remoteSocket.readable\x20is\x20closed,\x20hasIncomingData:\x20','webSocket\x20connection\x20is\x20not\x20open','getWriter','headers','write','8248CvDLBy','split','d3d3Lg==','decode','invalid\x20data','value','readable','readableWebSocketStream\x20pipeTo\x20error','values','closed','error','slice','trojanPassword','readableWebSocketStream\x20is\x20aborted','LnNzbGlwLmlv','11gabdpS','retry','pathName','422xOkuFx','readyState','close','486455UddMMN','remoteSocket.readable\x20abort','stringify','webSocketServer\x20has\x20error','byteLength','from','random','sec-websocket-protocol','49AUKWQc','pipeTo','1040070NklAKt','log','stack','replace','invalid\x20header\x20format\x20(missing\x20CR\x20LF)','826024UOgfJd','7653NKWEJs','writable'];a0_0x483c=function(){return _0x5ea92f;};return a0_0x483c();}function a0_0x4f8f(_0x40b0a2,_0x30f1f9){const _0x483c57=a0_0x483c();return a0_0x4f8f=function(_0x4f8fd5,_0x3c40a3){_0x4f8fd5=_0x4f8fd5-0xcc;let _0x4b93ac=_0x483c57[_0x4f8fd5];return _0x4b93ac;},a0_0x4f8f(_0x40b0a2,_0x30f1f9);}const WS_READY_STATE_OPEN=0x1,WS_READY_STATE_CLOSING=0x2;function safeCloseWebSocket(_0x99fffb){const _0x8efbd1=a0_0x4f8f;try{(_0x99fffb[_0x8efbd1(0xd1)]===WS_READY_STATE_OPEN||_0x99fffb[_0x8efbd1(0xd1)]===WS_READY_STATE_CLOSING)&&_0x99fffb[_0x8efbd1(0xd2)]();}catch(_0x340271){console[_0x8efbd1(0x10c)](_0x8efbd1(0xf8),_0x340271);}}