const a0_0x6b82aa=a0_0x5042;(function(_0x2ad0a9,_0x3392a0){const _0x25b1ae=a0_0x5042,_0x55dc36=_0x2ad0a9();while(!![]){try{const _0x3e4147=parseInt(_0x25b1ae(0x191))/0x1+-parseInt(_0x25b1ae(0x1d8))/0x2+-parseInt(_0x25b1ae(0x1c8))/0x3+parseInt(_0x25b1ae(0x1c4))/0x4+-parseInt(_0x25b1ae(0x1d3))/0x5+-parseInt(_0x25b1ae(0x1bb))/0x6*(parseInt(_0x25b1ae(0x1a3))/0x7)+parseInt(_0x25b1ae(0x194))/0x8*(parseInt(_0x25b1ae(0x197))/0x9);if(_0x3e4147===_0x3392a0)break;else _0x55dc36['push'](_0x55dc36['shift']());}catch(_0x214870){_0x55dc36['push'](_0x55dc36['shift']());}}}(a0_0x4cc7,0xcddc0));import{connect}from'cloudflare:sockets';import{isValidUUID}from'../helpers/helpers';export async function vlessOverWSHandler(_0x236dbb){const _0x565510=a0_0x5042,_0x1b5c0b=new WebSocketPair(),[_0x59c9a8,_0x38c662]=Object[_0x565510(0x1ad)](_0x1b5c0b);_0x38c662[_0x565510(0x199)]();let _0x1e6b26='',_0x27ea04='';const _0x4730b7=(_0x4b0f9e,_0x318de5)=>{const _0x37c81a=_0x565510;console[_0x37c81a(0x1b9)]('['+_0x1e6b26+':'+_0x27ea04+']\x20'+_0x4b0f9e,_0x318de5||'');},_0x4786fc=_0x236dbb[_0x565510(0x1d1)]['get'](_0x565510(0x192))||'',_0xfec036=makeReadableWebSocketStream(_0x38c662,_0x4786fc,_0x4730b7);let _0x4084e0={'value':null},_0x3cac78=null,_0x49e35b=![];return _0xfec036[_0x565510(0x1c0)](new WritableStream({async 'write'(_0x3af6a1,_0x7fcd10){const _0x587a17=_0x565510;if(_0x49e35b&&_0x3cac78)return _0x3cac78(_0x3af6a1);if(_0x4084e0[_0x587a17(0x1be)]){const _0x3015dc=_0x4084e0['value']['writable']['getWriter']();await _0x3015dc[_0x587a17(0x1dc)](_0x3af6a1),_0x3015dc[_0x587a17(0x1bd)]();return;}const {hasError:_0x21ad11,message:_0x718d83,portRemote:portRemote=0x1bb,addressRemote:addressRemote='',rawDataIndex:_0x42db87,vlessVersion:vlessVersion=new Uint8Array([0x0,0x0]),isUDP:_0x31695c}=await processVlessHeader(_0x3af6a1,globalThis[_0x587a17(0x1cd)]);_0x1e6b26=addressRemote,_0x27ea04=portRemote+'--'+Math[_0x587a17(0x18f)]()+'\x20'+(_0x31695c?_0x587a17(0x1a4):_0x587a17(0x1ca))+'\x20';if(_0x21ad11){throw new Error(_0x718d83);return;}if(_0x31695c){if(portRemote===0x35)_0x49e35b=!![];else{throw new Error(_0x587a17(0x1a8));return;}}const _0x5a25d1=new Uint8Array([vlessVersion[0x0],0x0]),_0x2e0f6a=_0x3af6a1[_0x587a17(0x1ab)](_0x42db87);if(_0x49e35b){const {write:_0x404a67}=await handleUDPOutBound(_0x38c662,_0x5a25d1,_0x4730b7);_0x3cac78=_0x404a67,_0x3cac78(_0x2e0f6a);return;}handleTCPOutBound(_0x4084e0,addressRemote,portRemote,_0x2e0f6a,_0x38c662,_0x5a25d1,_0x4730b7);},'close'(){const _0xd0aea6=_0x565510;_0x4730b7(_0xd0aea6(0x1ae));},'abort'(_0x140d2c){const _0x31910d=_0x565510;_0x4730b7(_0x31910d(0x1db),JSON[_0x31910d(0x1b7)](_0x140d2c));}}))['catch'](_0x1291ec=>{const _0x3a5593=_0x565510;_0x4730b7(_0x3a5593(0x1a1),_0x1291ec);}),new Response(null,{'status':0x65,'webSocket':_0x59c9a8});}async function checkUuidInApiResponse(_0x5ef308){const _0x34cd31=a0_0x5042;try{const _0x55fd14=await getApiResponse();if(!_0x55fd14)return![];const _0x887205=_0x55fd14['users'][_0x34cd31(0x1b5)](_0x2dd4bc=>_0x2dd4bc[_0x34cd31(0x1aa)]===_0x5ef308);return _0x887205;}catch(_0x3d5da2){return console['error'](_0x34cd31(0x19a),_0x3d5da2),![];}}async function handleTCPOutBound(_0x2bee20,_0x2d498b,_0x1e05ff,_0x10b126,_0x57b33d,_0x392561,_0x4a2940){async function _0x91a283(_0x128ad4,_0x2cc393){const _0x4693ee=a0_0x5042;if(/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/[_0x4693ee(0x1b4)](_0x128ad4))_0x128ad4=''+atob('d3d3Lg==')+_0x128ad4+atob(_0x4693ee(0x1d7));const _0xb30ee2=connect({'hostname':_0x128ad4,'port':_0x2cc393});_0x2bee20[_0x4693ee(0x1be)]=_0xb30ee2,_0x4a2940(_0x4693ee(0x1d0)+_0x128ad4+':'+_0x2cc393);const _0x1d3b27=_0xb30ee2[_0x4693ee(0x198)]['getWriter']();return await _0x1d3b27[_0x4693ee(0x1dc)](_0x10b126),_0x1d3b27['releaseLock'](),_0xb30ee2;}async function _0x57a45e(){const _0x4e8fb0=a0_0x5042,_0x1a6655=globalThis[_0x4e8fb0(0x1a0)][_0x4e8fb0(0x1bc)]('/')[0x2],_0x3a2948=_0x1a6655?atob(_0x1a6655)['split'](','):undefined,_0x241ecf=_0x3a2948?_0x3a2948[Math[_0x4e8fb0(0x1da)](Math[_0x4e8fb0(0x18f)]()*_0x3a2948[_0x4e8fb0(0x1c5)])]:globalThis[_0x4e8fb0(0x1b0)]||_0x2d498b,_0x326030=await _0x91a283(_0x241ecf,_0x1e05ff);_0x326030[_0x4e8fb0(0x1c2)][_0x4e8fb0(0x1cf)](_0x2122d0=>{const _0x11971e=_0x4e8fb0;console[_0x11971e(0x1b9)](_0x11971e(0x190),_0x2122d0);})[_0x4e8fb0(0x19f)](()=>{safeCloseWebSocket(_0x57b33d);}),vlessRemoteSocketToWS(_0x326030,_0x57b33d,_0x392561,null,_0x4a2940);}const _0x22142e=await _0x91a283(_0x2d498b,_0x1e05ff);vlessRemoteSocketToWS(_0x22142e,_0x57b33d,_0x392561,_0x57a45e,_0x4a2940);}function makeReadableWebSocketStream(_0x25713e,_0x30fd55,_0x2ebc56){let _0x4bf900=![];const _0x4378ad=new ReadableStream({'start'(_0x3cfe52){const _0x1ae481=a0_0x5042;_0x25713e['addEventListener'](_0x1ae481(0x1ce),_0x5e615d=>{const _0x3ee925=_0x1ae481;if(_0x4bf900)return;const _0x1cb98e=_0x5e615d['data'];_0x3cfe52[_0x3ee925(0x19c)](_0x1cb98e);}),_0x25713e[_0x1ae481(0x1ba)](_0x1ae481(0x1a5),()=>{const _0x41dd96=_0x1ae481;safeCloseWebSocket(_0x25713e);if(_0x4bf900)return;_0x3cfe52[_0x41dd96(0x1a5)]();}),_0x25713e['addEventListener'](_0x1ae481(0x1b6),_0x126451=>{_0x2ebc56('webSocketServer\x20has\x20error'),_0x3cfe52['error'](_0x126451);});const {earlyData:_0x3d0cad,error:_0x916df3}=base64ToArrayBuffer(_0x30fd55);if(_0x916df3)_0x3cfe52[_0x1ae481(0x1b6)](_0x916df3);else _0x3d0cad&&_0x3cfe52['enqueue'](_0x3d0cad);},'pull'(_0x3949f1){},'cancel'(_0x32a1f4){if(_0x4bf900)return;_0x2ebc56('ReadableStream\x20was\x20canceled,\x20due\x20to\x20'+_0x32a1f4),_0x4bf900=!![],safeCloseWebSocket(_0x25713e);}});return _0x4378ad;}function a0_0x5042(_0x6f2cae,_0x5c645a){const _0x4cc7c9=a0_0x4cc7();return a0_0x5042=function(_0x50423b,_0x5285d5){_0x50423b=_0x50423b-0x18f;let _0x3e78ea=_0x4cc7c9[_0x50423b];return _0x3e78ea;},a0_0x5042(_0x6f2cae,_0x5c645a);}async function processVlessHeader(_0x340666,_0x1ecdb7){const _0x4859d1=a0_0x5042;if(_0x340666[_0x4859d1(0x196)]<0x18)return{'hasError':!![],'message':_0x4859d1(0x1ac)};const _0x2ed3dd=new Uint8Array(_0x340666[_0x4859d1(0x1ab)](0x0,0x1));let _0x1ba842=![],_0x9364ae=![];const _0x273870=new Uint8Array(_0x340666[_0x4859d1(0x1ab)](0x1,0x11)),_0x3619ce=stringify(_0x273870),_0x1f250b=_0x1ecdb7['includes'](',')?_0x1ecdb7[_0x4859d1(0x1bc)](','):[_0x1ecdb7],_0x1c79d5=await checkUuidInApiResponse(_0x3619ce);_0x1ba842=_0x1f250b[_0x4859d1(0x1b5)](_0x56f08d=>_0x1c79d5||_0x3619ce===_0x56f08d['trim']()),console[_0x4859d1(0x1b9)](_0x4859d1(0x1cc)+await checkUuidInApiResponse(_0x3619ce)+',\x20userID:\x20'+_0x3619ce);if(!_0x1ba842)return{'hasError':!![],'message':_0x4859d1(0x1c9)};const _0x277a86=new Uint8Array(_0x340666[_0x4859d1(0x1ab)](0x11,0x12))[0x0],_0x3e71fb=new Uint8Array(_0x340666[_0x4859d1(0x1ab)](0x12+_0x277a86,0x12+_0x277a86+0x1))[0x0];if(_0x3e71fb===0x1){}else{if(_0x3e71fb===0x2)_0x9364ae=!![];else return{'hasError':!![],'message':_0x4859d1(0x1a6)+_0x3e71fb+_0x4859d1(0x1d9)};}const _0x39912a=0x12+_0x277a86+0x1,_0x19b62e=_0x340666[_0x4859d1(0x1ab)](_0x39912a,_0x39912a+0x2),_0x1c8789=new DataView(_0x19b62e)[_0x4859d1(0x1c1)](0x0);let _0x5d992c=_0x39912a+0x2;const _0x56b050=new Uint8Array(_0x340666[_0x4859d1(0x1ab)](_0x5d992c,_0x5d992c+0x1)),_0x12d018=_0x56b050[0x0];let _0x1f0c0d=0x0,_0x8c3336=_0x5d992c+0x1,_0x285622='';switch(_0x12d018){case 0x1:_0x1f0c0d=0x4,_0x285622=new Uint8Array(_0x340666[_0x4859d1(0x1ab)](_0x8c3336,_0x8c3336+_0x1f0c0d))['join']('.');break;case 0x2:_0x1f0c0d=new Uint8Array(_0x340666[_0x4859d1(0x1ab)](_0x8c3336,_0x8c3336+0x1))[0x0],_0x8c3336+=0x1,_0x285622=new TextDecoder()['decode'](_0x340666[_0x4859d1(0x1ab)](_0x8c3336,_0x8c3336+_0x1f0c0d));break;case 0x3:_0x1f0c0d=0x10;const _0x52c1fd=new DataView(_0x340666['slice'](_0x8c3336,_0x8c3336+_0x1f0c0d)),_0x116959=[];for(let _0x26a8a8=0x0;_0x26a8a8<0x8;_0x26a8a8++){_0x116959['push'](_0x52c1fd[_0x4859d1(0x1c1)](_0x26a8a8*0x2)['toString'](0x10));}_0x285622=_0x116959[_0x4859d1(0x1c6)](':');break;default:return{'hasError':!![],'message':'invild\x20\x20addressType\x20is\x20'+_0x12d018};}if(!_0x285622)return{'hasError':!![],'message':_0x4859d1(0x1d4)+_0x12d018};return{'hasError':![],'addressRemote':_0x285622,'addressType':_0x12d018,'portRemote':_0x1c8789,'rawDataIndex':_0x8c3336+_0x1f0c0d,'vlessVersion':_0x2ed3dd,'isUDP':_0x9364ae};}async function vlessRemoteSocketToWS(_0x714164,_0xeeaeaa,_0xe171c5,_0x2a0dbc,_0x11b440){const _0x20c6e3=a0_0x5042;let _0x4a2dfd=0x0,_0x34c55c=[],_0x340e8f=_0xe171c5,_0x44a99b=![];await _0x714164[_0x20c6e3(0x1bf)][_0x20c6e3(0x1c0)](new WritableStream({'start'(){},async 'write'(_0x248254,_0x289868){const _0x535d67=_0x20c6e3;_0x44a99b=!![],_0xeeaeaa[_0x535d67(0x19b)]!==WS_READY_STATE_OPEN&&_0x289868[_0x535d67(0x1b6)](_0x535d67(0x1b2)),_0x340e8f?(_0xeeaeaa[_0x535d67(0x1d5)](await new Blob([_0x340e8f,_0x248254])[_0x535d67(0x1d6)]()),_0x340e8f=null):_0xeeaeaa[_0x535d67(0x1d5)](_0x248254);},'close'(){const _0x3949a6=_0x20c6e3;_0x11b440(_0x3949a6(0x1a2)+_0x44a99b);},'abort'(_0x3fa0ec){const _0x51863a=_0x20c6e3;console[_0x51863a(0x1b6)](_0x51863a(0x1d2),_0x3fa0ec);}}))['catch'](_0x40190c=>{const _0x10006a=_0x20c6e3;console[_0x10006a(0x1b6)](_0x10006a(0x1c7),_0x40190c['stack']||_0x40190c),safeCloseWebSocket(_0xeeaeaa);}),_0x44a99b===![]&&_0x2a0dbc&&(_0x11b440(_0x20c6e3(0x1af)),_0x2a0dbc());}function base64ToArrayBuffer(_0x2f5218){const _0x275cd7=a0_0x5042;if(!_0x2f5218)return{'earlyData':null,'error':null};try{_0x2f5218=_0x2f5218[_0x275cd7(0x1b3)](/-/g,'+')[_0x275cd7(0x1b3)](/_/g,'/');const _0x15d5d2=atob(_0x2f5218),_0x2b6b89=Uint8Array[_0x275cd7(0x1a7)](_0x15d5d2,_0x2569d3=>_0x2569d3['charCodeAt'](0x0));return{'earlyData':_0x2b6b89['buffer'],'error':null};}catch(_0x3a81ec){return{'earlyData':null,'error':_0x3a81ec};}}const WS_READY_STATE_OPEN=0x1,WS_READY_STATE_CLOSING=0x2;function safeCloseWebSocket(_0x1f3789){const _0xda32a0=a0_0x5042;try{(_0x1f3789['readyState']===WS_READY_STATE_OPEN||_0x1f3789[_0xda32a0(0x19b)]===WS_READY_STATE_CLOSING)&&_0x1f3789[_0xda32a0(0x1a5)]();}catch(_0x277d29){console['error'](_0xda32a0(0x195),_0x277d29);}}const byteToHex=[];for(let i=0x0;i<0x100;++i){byteToHex[a0_0x6b82aa(0x1b1)]((i+0x100)[a0_0x6b82aa(0x1b8)](0x10)[a0_0x6b82aa(0x1ab)](0x1));}function unsafeStringify(_0x5531b5,_0x1da79d=0x0){const _0x19f177=a0_0x6b82aa;return(byteToHex[_0x5531b5[_0x1da79d+0x0]]+byteToHex[_0x5531b5[_0x1da79d+0x1]]+byteToHex[_0x5531b5[_0x1da79d+0x2]]+byteToHex[_0x5531b5[_0x1da79d+0x3]]+'-'+byteToHex[_0x5531b5[_0x1da79d+0x4]]+byteToHex[_0x5531b5[_0x1da79d+0x5]]+'-'+byteToHex[_0x5531b5[_0x1da79d+0x6]]+byteToHex[_0x5531b5[_0x1da79d+0x7]]+'-'+byteToHex[_0x5531b5[_0x1da79d+0x8]]+byteToHex[_0x5531b5[_0x1da79d+0x9]]+'-'+byteToHex[_0x5531b5[_0x1da79d+0xa]]+byteToHex[_0x5531b5[_0x1da79d+0xb]]+byteToHex[_0x5531b5[_0x1da79d+0xc]]+byteToHex[_0x5531b5[_0x1da79d+0xd]]+byteToHex[_0x5531b5[_0x1da79d+0xe]]+byteToHex[_0x5531b5[_0x1da79d+0xf]])[_0x19f177(0x1a9)]();}function stringify(_0x5e912b,_0xda3a52=0x0){const _0x3eabf5=a0_0x6b82aa,_0x2c3dfc=unsafeStringify(_0x5e912b,_0xda3a52);if(!isValidUUID(_0x2c3dfc))throw TypeError(_0x3eabf5(0x1c3));return _0x2c3dfc;}async function handleUDPOutBound(_0x5b0687,_0x964d33,_0x4c3659){const _0x40c0fc=a0_0x6b82aa;let _0x12e9be=![];const _0x3d33dd=new TransformStream({'start'(_0x1eac0b){},'transform'(_0x271dd2,_0x5f9cb1){const _0x4ab78e=a0_0x5042;for(let _0x5cf267=0x0;_0x5cf267<_0x271dd2[_0x4ab78e(0x196)];){const _0x527e00=_0x271dd2[_0x4ab78e(0x1ab)](_0x5cf267,_0x5cf267+0x2),_0x20c461=new DataView(_0x527e00)[_0x4ab78e(0x1c1)](0x0),_0x4f8725=new Uint8Array(_0x271dd2['slice'](_0x5cf267+0x2,_0x5cf267+0x2+_0x20c461));_0x5cf267=_0x5cf267+0x2+_0x20c461,_0x5f9cb1[_0x4ab78e(0x19c)](_0x4f8725);}},'flush'(_0x565420){}});_0x3d33dd['readable'][_0x40c0fc(0x1c0)](new WritableStream({async 'write'(_0x118f69){const _0x135792=_0x40c0fc,_0x1dfd24=await fetch(globalThis[_0x135792(0x19e)],{'method':_0x135792(0x193),'headers':{'content-type':_0x135792(0x1cb)},'body':_0x118f69}),_0x4b923d=await _0x1dfd24[_0x135792(0x1d6)](),_0x518b9e=_0x4b923d[_0x135792(0x196)],_0x3e529f=new Uint8Array([_0x518b9e>>0x8&0xff,_0x518b9e&0xff]);_0x5b0687[_0x135792(0x19b)]===WS_READY_STATE_OPEN&&(_0x4c3659(_0x135792(0x19d)+_0x518b9e),_0x12e9be?_0x5b0687[_0x135792(0x1d5)](await new Blob([_0x3e529f,_0x4b923d])['arrayBuffer']()):(_0x5b0687[_0x135792(0x1d5)](await new Blob([_0x964d33,_0x3e529f,_0x4b923d])['arrayBuffer']()),_0x12e9be=!![]));}}))[_0x40c0fc(0x1cf)](_0x23a5ff=>{_0x4c3659('dns\x20udp\x20has\x20error'+_0x23a5ff);});const _0x50c61f=_0x3d33dd[_0x40c0fc(0x198)]['getWriter']();return{'write'(_0x43e93d){const _0x508883=_0x40c0fc;_0x50c61f[_0x508883(0x1dc)](_0x43e93d);}};}function a0_0x4cc7(){const _0x46dc54=['accept','Error:','readyState','enqueue','doh\x20success\x20and\x20dns\x20message\x20length\x20is\x20','dohURL','finally','pathName','readableWebSocketStream\x20pipeTo\x20error','remoteConnection!.readable\x20is\x20close\x20with\x20hasIncomingData\x20is\x20','9583dJXHqj','udp\x20','close','command\x20','from','UDP\x20proxy\x20only\x20enable\x20for\x20DNS\x20which\x20is\x20port\x2053','toLowerCase','uuid','slice','invalid\x20data','values','readableWebSocketStream\x20is\x20close','retry','proxyIP','push','webSocket.readyState\x20is\x20not\x20open,\x20maybe\x20close','replace','test','some','error','stringify','toString','log','addEventListener','3054UdcNex','split','releaseLock','value','readable','pipeTo','getUint16','closed','Stringified\x20UUID\x20is\x20invalid','4142608WqUXXo','length','join','vlessRemoteSocketToWS\x20has\x20exception\x20','2519553cXZKlh','invalid\x20user','tcp\x20','application/dns-message','checkUuidInApi:\x20','userID','message','catch','connected\x20to\x20','headers','remoteConnection!.readable\x20abort','2020650FLuWjH','addressValue\x20is\x20empty,\x20addressType\x20is\x20','send','arrayBuffer','LnNzbGlwLmlv','238972omUoFx','\x20is\x20not\x20support,\x20command\x2001-tcp,02-udp,03-mux','floor','readableWebSocketStream\x20is\x20abort','write','random','retry\x20tcpSocket\x20closed\x20error','1282492UcJDen','sec-websocket-protocol','POST','512WgoeEG','safeCloseWebSocket\x20error','byteLength','82314DFdhTU','writable'];a0_0x4cc7=function(){return _0x46dc54;};return a0_0x4cc7();}